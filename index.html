<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SillyTavern å¹´åº¦æ€»ç»“</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url("https://fontsapi.zeoseven.com/4/main/result.css");
        @import url("https://fontsapi.zeoseven.com/309/main/result.css");

        :root {
            /* é»˜è®¤é…è‰²ï¼šæ³›é»„æ—§çº¸ */
            --bg-color: #f4f1ea;
            --paper-texture: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZjRmMWVhIi8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiNjYmM4YjkiIG9wYWNpdHk9IjAuMiIvPgo8L3N2Zz4=');
            --text-color: #2c2c2c;
            --accent-color: #8b4513;
            --border-color: #dcd6cc;
            --font-family: "KingHwaOldSong", "Songti SC", "Noto Serif SC", "SimSun", serif;
            --shadow-color: rgba(0,0,0,0.5);
            --highlight-bg: rgba(255,255,255,0.1);
        }

        /* é…è‰²æ–¹æ¡ˆç±» */
        body.theme-white {
            --bg-color: #fdfdfd;
            --paper-texture: none;
            --text-color: #333;
            --accent-color: #4a6fa5;
            --border-color: #eee;
            --shadow-color: rgba(0,0,0,0.3);
            --highlight-bg: rgba(74,111,165,0.05);
        }
        
        body.theme-pink {
            --bg-color: #fff0f5;
            --paper-texture: none;
            --text-color: #5d3a43;
            --accent-color: #d67b93;
            --border-color: #f3dce2;
            --shadow-color: rgba(214,123,147,0.3);
            --highlight-bg: rgba(214,123,147,0.08);
        }

        /* å®‡å®™æ˜Ÿ - æ·±é‚ƒé»‘é‡‘é…è‰² */
        body.theme-å®‡å®™æ˜Ÿ {
            --bg-color: #0a0a0a;
            --paper-texture: none;
            --text-color: #d4af37;
            --accent-color: #ffd700;
            --border-color: #333333;
            --shadow-color: rgba(212,175,55,0.4);
            --highlight-bg: rgba(212,175,55,0.08);
        }

        /* æ‹çˆ±é€šå‘Š - æµªæ¼«ç²‰è“é…è‰² */
        body.theme-æ‹çˆ±é€šå‘Š {
            --bg-color: #f5dadc;
            --paper-texture: none;
            --text-color: #4a4a4a;
            --accent-color: #6274ce;
            --border-color: #e8c4c8;
            --shadow-color: rgba(98,116,206,0.3);
            --highlight-bg: rgba(98,116,206,0.08);
        }

        /* æ—¥å½±ä¸‹ - æ¸©æŸ”ç±³ç°é…è‰² */
        body.theme-æ—¥å½±ä¸‹ {
            --bg-color: #e8e6e0;
            --paper-texture: none;
            --text-color: #5a5a5a;
            --accent-color: #8a8a8a;
            --border-color: #d0cec8;
            --shadow-color: rgba(138,138,138,0.3);
            --highlight-bg: rgba(138,138,138,0.06);
        }

        /* çº¢ä¸é»‘ - å¼ºçƒˆå¯¹æ¯”é…è‰² */
        body.theme-çº¢ä¸é»‘ {
            --bg-color: #1a1a1a;
            --paper-texture: none;
            --text-color: #ffffff;
            --accent-color: #d32f2f;
            --border-color: #4a4a4a;
            --shadow-color: rgba(211,47,47,0.5);
            --highlight-bg: rgba(211,47,47,0.12);
        }

        /* è†æ£˜æµ· - æ·±è“ç±³é»„é…è‰² */
        body.theme-è†æ£˜æµ· {
            --bg-color: #2c3e5a;
            --paper-texture: none;
            --text-color: #f5f0e8;
            --accent-color: #d4c5a0;
            --border-color: #3f5273;
            --shadow-color: rgba(212,197,160,0.4);
            --highlight-bg: rgba(212,197,160,0.12);
        }

        /* è¿·é›¾è“ - æš–å¥¶æ²¹è“ç°é…è‰² */
        body.theme-è¿·é›¾è“ {
            --bg-color: #fdf4e3;
            --paper-texture: none;
            --text-color: #4a4a4a;
            --accent-color: #7c8d99;
            --border-color: #e8dcc8;
            --shadow-color: rgba(124,141,153,0.3);
            --highlight-bg: rgba(124,141,153,0.08);
        }

        * { 
            box-sizing: border-box; 
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body {
            margin: 0;
            padding: 20px;
            background: #e0e0e0;
            font-family: var(--font-family);
            font-weight: normal;
            font-feature-settings: "hwid"; /* å¯ç”¨ç­‰å®½å˜åŒ–å­—å½¢ */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* ç”Ÿæˆå›¾ç‰‡æ—¶çš„ç‰¹æ®Šæ ·å¼ */
        body.generating-image {
            overflow: hidden;
        }

        body.generating-image #paper-container::before {
            content: none !important;
            display: none !important;
            background-image: none !important;
            filter: none !important;
        }

        /* ç”Ÿæˆå›¾ç‰‡æ—¶è¿›ä¸€æ­¥å‹ç¼©åº•éƒ¨ç©ºé—´ */
        body.generating-image .generated-url {
            margin-top: 10px !important;
            margin-bottom: 0 !important;
        }

        body.generating-image #paper-container {
            box-shadow: none !important;
            animation: none !important;
            transform: none !important;
            margin: 0 !important;
            padding-bottom: 10px !important; /* æè‡´å‹ç¼©åº•éƒ¨ */
        }

        /* ç”Ÿæˆå›¾ç‰‡æ—¶éšè—æ‰€æœ‰äº¤äº’å…ƒç´  */
        body.generating-image .controls,
        body.generating-image .menu-toggle,
        body.generating-image .delete-btn,
        body.generating-image .delete-img-btn,
        body.generating-image .restore-tag,
        body.generating-image .restore-img-btn,
        body.generating-image .copyright-watermark,
        body.generating-image #toast {
            display: none !important;
        }

        /* ç”Ÿæˆå›¾ç‰‡æ—¶éšè—è¾“å…¥æ¡†è¾¹æ¡† */
        body.generating-image .input-line,
        body.generating-image .textarea-box {
            border-color: transparent;
            border-bottom: 2px dashed var(--text-color); /* ä»…ä¿ç•™ä¸‹åˆ’çº¿ */
            background: transparent;
            box-shadow: none;
            resize: none;
        }

        body.generating-image .textarea-box {
            border: 2px dashed transparent; 
        }

        /* ç”Ÿæˆæ—¶çš„æ–‡æœ¬æ›¿èº«æ ·å¼ */
        .print-text-replacement {
            font-family: inherit;
            color: inherit;
            line-height: inherit;
            letter-spacing: inherit;
            font-weight: inherit;
            white-space: pre-wrap;
            word-break: break-word;
            border-bottom: 2px dashed var(--text-color); /* ä¿æŒä¸‹åˆ’çº¿é£æ ¼ */
            min-height: 1.5em;
        }

        /* ç‰ˆæƒæ°´å° */
        .copyright-watermark {
            position: fixed;
            bottom: 15px;
            right: 15px;
            font-family: "JinzisheTongyuan", serif;
            font-size: 12px;
            color: #999;
            z-index: 0; /* ä½äºä¸»ä½“å†…å®¹(z-index:1)ä¹‹ä¸‹ï¼Œæ»šåŠ¨æ—¶ä¼šè¢«é®æŒ¡ */
            pointer-events: none; /* å®¹å™¨æœ¬èº«é€ä¼  */
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .watermark-text {
            opacity: 0.6;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
        }

        .github-link {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            opacity: 0.4;
            transition: all 0.3s ease;
            pointer-events: auto; /* é“¾æ¥éœ€è¦å¯ç‚¹å‡» */
            text-decoration: none;
        }

        .github-link svg {
            width: 14px;
            height: 14px;
        }

        .github-link:hover {
            opacity: 1;
            color: #333;
            transform: scale(1.1) rotate(360deg);
        }

        /* èœå•åˆ‡æ¢æŒ‰é’® */
        .menu-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 101;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 20px;
            border: 2px solid #fff;
        }
        
        .menu-toggle:hover {
            transform: scale(1.1);
        }

        .menu-toggle.active {
            transform: rotate(45deg);
            background: #333;
            color: white;
            border-color: #333;
        }

        /* æ§åˆ¶æ  */
        .controls {
            position: fixed;
            top: 75px;
            right: 20px;
            background: rgba(253, 253, 253, 0.96);
            padding: 24px;
            border-radius: 4px; /* å°åœ†è§’ï¼Œæ›´æ˜¾çº¸è´¨æ„Ÿ */
            box-shadow: 0 4px 24px rgba(0,0,0,0.06), 0 1px 4px rgba(0,0,0,0.04);
            border: 1px solid #eaeae5;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 16px;
            backdrop-filter: blur(8px);
            max-width: 260px;
            max-height: 85vh;
            overflow-y: auto;
            font-family: var(--font-family); /* ç»Ÿä¸€å­—ä½“ */
            
            /* é»˜è®¤æ”¶èµ·çŠ¶æ€ */
            opacity: 0;
            visibility: hidden;
            transform: translateX(20px);
            transition: all 0.4s cubic-bezier(0.2, 0, 0, 1);
        }

        .controls.active {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }

        .controls-header {
            font-weight: normal;
            font-size: 15px;
            color: #2c2c2c;
            margin-bottom: 4px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
            text-align: center;
            letter-spacing: 2px;
        }

        .theme-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .btn {
            padding: 8px 12px;
            border: 1px solid #dcdcdc;
            background: #fff;
            cursor: pointer;
            border-radius: 2px; /* å¾®åœ†è§’ */
            font-family: var(--font-family);
            font-size: 13px;
            color: #666;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            letter-spacing: 1px;
            outline: none;
        }
        
        .btn:hover { 
            border-color: #555;
            color: #333;
            background: #fafafa;
        }
        
        /* é€‰ä¸­çŠ¶æ€ - é»‘è‰² */
        .btn.active {
            background: #2c2c2c;
            color: #fff;
            border-color: #2c2c2c;
        }

        /* ä¸»æ“ä½œæŒ‰é’® */
        .btn-primary { 
            background: #2c2c2c;
            color: #f0f0f0;
            border: 1px solid #2c2c2c;
            font-size: 14px;
            padding: 12px 20px;
            margin-top: 10px;
            width: 100%;
        }
        
        .btn-primary:hover { 
            background: #444;
            border-color: #444;
            color: #fff;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .btn-primary:disabled {
            background: #999;
            border-color: #999;
            cursor: not-allowed;
            transform: none;
        }

        .theme-section {
            margin-bottom: 8px;
        }

        .section-title {
            font-size: 11px;
            color: #999;
            margin-bottom: 10px;
            font-weight: normal;
            text-align: center;
            position: relative;
        }
        
        .section-title::before,
        .section-title::after {
            content: "";
            display: inline-block;
            width: 20px;
            height: 1px;
            background: #eee;
            vertical-align: middle;
            margin: 0 8px;
        }

        /* è‡ªå®šä¹‰ç¼–è¾‘å™¨å†…éƒ¨æ ·å¼ */
        #custom-editor {
            background: #fdfdfd !important;
            border: 1px solid #eee;
            border-radius: 4px !important;
        }

        /* çº¸å¼ å®¹å™¨ */
        #paper-container {
            width: 100%;
            max-width: 400px;
            background: var(--bg-color);
            background-image: var(--paper-texture);
            color: var(--text-color);
            padding: 40px 25px;
            box-shadow: 
                0 20px 60px rgba(0,0,0,0.3),
                0 10px 30px rgba(0,0,0,0.2),
                inset 0 0 0 1px rgba(255,255,255,0.1);
            position: relative;
            border-radius: 4px;
            z-index: 1;
            animation: slideIn 0.8s ease-out;
            margin-bottom: 40px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* æ¨¡æ‹Ÿçº¸å¼ å™ªç‚¹è´¨æ„Ÿ */
        #paper-container::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 0;
            border-radius: 12px;
        }

        .content-wrapper {
            position: relative;
            z-index: 1; /* ç¡®ä¿å†…å®¹åœ¨å™ªç‚¹ä¹‹ä¸Š */
        }

        @keyframes sparkle {
            0%, 100% { opacity: 0.5; transform: rotate(0deg) scale(1); }
            50% { opacity: 1; transform: rotate(180deg) scale(1.2); }
        }

        /* è¾“å…¥åŒºåŸŸæ ·å¼ */
        .section {
            margin-bottom: 35px;
            padding: 20px;
            background: var(--highlight-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .section:last-of-type {
            margin-bottom: 0;
        }

        /* ç”Ÿæˆå›¾åº•éƒ¨ç½‘å€ */
        .generated-url {
            text-align: center;
            margin-top: 30px;
            font-size: 10px;
            color: var(--accent-color);
            opacity: 0.5;
            font-family: sans-serif;
            letter-spacing: 1px;
        }

        .question-row {
            margin-bottom: 18px;
            line-height: 2;
            font-size: 18px;
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
        }

        .label {
            margin-right: 8px;
            font-weight: 600;
            color: var(--accent-color);
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* æ¨¡æ‹Ÿå¡«ç©ºä¸‹åˆ’çº¿ */
        .input-line {
            border: none;
            background: transparent;
            border-bottom: 2px dashed var(--text-color);
            color: var(--text-color);
            font-family: inherit;
            font-size: 18px;
            padding: 4px 8px;
            flex: 1;
            min-width: 100px;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .input-line:focus {
            border-bottom: 2px solid var(--accent-color);
            background: var(--highlight-bg);
            transform: translateY(-1px);
        }

        .input-line:hover {
            border-bottom-style: solid;
        }

        /* å¤šè¡Œæ–‡æœ¬åŒºåŸŸ */
        .textarea-box {
            width: 100%;
            border: 2px dashed var(--border-color);
            background: var(--highlight-bg);
            padding: 14px;
            min-height: 80px;
            font-family: inherit;
            font-size: 16px;
            color: var(--text-color);
            resize: none;
            outline: none;
            margin-top: 8px;
            line-height: 1.8;
            border-radius: 8px;
            transition: all 0.3s ease;
            overflow: hidden; /* éšè—æ»šåŠ¨æ¡ */
        }
        .textarea-box:focus {
            border-color: var(--accent-color);
            border-style: solid;
            box-shadow: 0 0 0 3px rgba(var(--accent-color), 0.1);
            background: rgba(255,255,255,0.2);
        }
        .textarea-box:hover {
            border-style: solid;
        }

        /* å¯ç¼–è¾‘æ–‡æœ¬ */
        .editable-text {
            border-bottom: 1px dashed var(--accent-color);
            cursor: pointer;
            padding: 0 2px;
            transition: all 0.2s;
            display: inline-block;
            min-width: 1em;
            text-align: center;
        }
        .editable-text:hover {
            background: var(--highlight-bg);
        }
        .editable-text:focus {
            outline: none;
            border-bottom: 2px solid var(--accent-color);
            background: rgba(255,255,255,0.5);
        }

        /* æœˆä»½å¡ç‰‡ç›¸å…³ */
        .month-block {
            border-left: 4px solid var(--accent-color);
            padding-left: 24px;
            margin: 45px 0;
            padding: 20px 24px;
            background: var(--highlight-bg);
            border-radius: 0 12px 12px 0;
            position: relative;
            transition: all 0.3s ease;
        }

        .delete-btn {
            position: absolute;
            top: -10px;
            left: -10px;
            width: 24px;
            height: 24px;
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .month-block:hover .delete-btn {
            opacity: 1;
        }

        /* å›¾ç‰‡åˆ é™¤æŒ‰é’® */
        .delete-img-btn {
            position: absolute;
            top: -8px;
            left: -8px;
            width: 20px;
            height: 20px;
            background: #666;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 20;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .polaroid:hover .delete-img-btn {
            opacity: 1;
        }

        /* æ¢å¤ç…§ç‰‡æŒ‰é’® */
        .restore-img-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            cursor: pointer;
            font-size: 12px;
            color: var(--accent-color);
            border: 1px dashed var(--accent-color);
            padding: 4px 8px;
            border-radius: 4px;
            opacity: 0.6;
            transition: all 0.2s;
            z-index: 5;
        }
        .restore-img-btn:hover {
            opacity: 1;
            background: rgba(255,255,255,0.5);
        }

        /* æ‹ç«‹å¾—ç…§ç‰‡ */
        .polaroid {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 100px;
            height: 120px;
            background: white;
            padding: 5px 5px 25px 5px;
            box-shadow: 2px 4px 8px rgba(0,0,0,0.15);
            transform: rotate(3deg);
            transition: transform 0.3s ease;
            cursor: pointer;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .polaroid:hover {
            transform: rotate(0deg) scale(1.05);
            z-index: 10;
            box-shadow: 4px 8px 16px rgba(0,0,0,0.2);
        }

        .polaroid-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #f0f0f0;
        }

        .polaroid-placeholder {
            font-size: 24px;
            color: #ccc;
            text-align: center;
        }

        .polaroid-placeholder span {
            display: block;
            font-size: 10px;
            margin-top: 5px;
        }

        /* é¡¶éƒ¨/åº•éƒ¨ä¿¡æ¯åŒº */
        .summary-header {
            text-align: center; 
            margin-bottom: 40px; 
            border-bottom: 2px dashed var(--accent-color); 
            padding-bottom: 20px;
        }
        
        .footer-title {
            font-size: 28px;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 20px;
            letter-spacing: 2px;
            border-bottom: 2px solid transparent;
            display: inline-block;
            transition: all 0.3s;
            cursor: pointer;
        }

        .footer-title:hover, .footer-title:focus {
            border-bottom-color: var(--accent-color);
            background: var(--highlight-bg);
            outline: none;
        }

        .maker-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            font-size: 16px;
            color: var(--text-color);
            align-items: center; /* æ”¹å›å±…ä¸­å¯¹é½ï¼Œä¿è¯è§†è§‰é«˜åº¦ä¸€è‡´ */
        }

        /* æœˆä»½ç®¡ç†åŒºåŸŸæ ·å¼ä¼˜åŒ– */
        #month-restorer {
            padding: 5px; 
            min-height: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
        }

        /* æ¢å¤æœˆä»½æŒ‰é’® - ç®€çº¦é£ */
        .restore-tag {
            display: inline-block;
            padding: 4px 10px;
            background: #fff;
            border-radius: 2px;
            font-size: 12px;
            cursor: pointer;
            color: #666;
            border: 1px dashed #ccc;
            transition: all 0.2s;
        }
        .restore-tag:hover {
            background: #2c2c2c;
            color: white;
            border-color: #2c2c2c;
            border-style: solid;
        }
        
        .textarea-short {
            min-height: 50px !important;
        }

        
        .month-title {
            font-size: 26px;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 18px;
            font-family: "KaiTi", "STKaiti", serif;
            position: relative;
            display: inline-block;
        }

        .month-title::after {
            content: "";
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-color), transparent);
        }

        .divider {
            text-align: center;
            margin: 50px 0;
            color: var(--accent-color);
            font-size: 16px;
            position: relative;
            font-weight: 500;
        }

        .divider::before,
        .divider::after {
            content: "";
            position: absolute;
            top: 50%;
            width: 30%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--border-color), transparent);
        }

        .divider::before { left: 0; }
        .divider::after { right: 0; }

        /* åº•éƒ¨ */
        .footer {
            text-align: center;
            margin-top: 30px;
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.6;
            border-top: 2px solid var(--border-color);
            padding-top: 10px;
            min-height: 20px;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        .controls::-webkit-scrollbar {
            width: 6px;
        }
        
        .controls::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .controls::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        
        .controls::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* åŠ è½½åŠ¨ç”» */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* æ·»åŠ è¾“å…¥ç„¦ç‚¹æ—¶çš„å…‰æ ‡åŠ¨ç”» */
        @keyframes blink {
            0%, 49% { border-right: 2px solid var(--accent-color); }
            50%, 100% { border-right: 2px solid transparent; }
        }

        /* æç¤ºæ¶ˆæ¯ */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            #paper-container { 
                padding: 30px 20px; 
                border-radius: 8px;
            }
            
            .question-row { 
                font-size: 16px; 
            }
            
            .controls { 
                top: 10px;
                right: 10px;
                padding: 12px;
                max-width: 240px;
            }

            .theme-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 24px;
                letter-spacing: 2px;
            }

            .month-title {
                font-size: 22px;
            }

            .section {
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .controls {
                max-width: 200px;
                padding: 10px;
            }

            .btn {
                font-size: 12px;
                padding: 8px 12px;
            }

            .controls-header {
                font-size: 14px;
            }
        }

        /* æ‰“å°æ ·å¼ */
        @media print {
            body {
                background: white;
                padding: 0;
            }

            .controls {
                display: none !important;
            }

            #paper-container {
                box-shadow: none;
                max-width: 100%;
            }

            .input-line,
            .textarea-box {
                border: none;
                border-bottom: 1px solid #ccc;
            }
        }

        /* é¢å¤–è£…é¥°æ•ˆæœ */
        .sparkle {
            position: fixed;
            pointer-events: none;
            animation: sparkleFloat 3s ease-out forwards;
            z-index: 9999;
        }

        @keyframes sparkleFloat {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(0);
                opacity: 0;
            }
        }
    </style>
</head>
<body>

    <!-- æç¤ºæ¶ˆæ¯ -->
    <div id="toast" class="toast"></div>

    <!-- èƒŒæ™¯æ°´å° -->
    <div class="copyright-watermark">
        <a href="https://github.com/Jingshiro/Year-in-ST" target="_blank" class="github-link" title="é¡¹ç›®æºç ">
            <svg viewBox="0 0 16 16" width="24" height="24" fill="currentColor">
                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
            </svg>
        </a>
        <div class="watermark-text">
            Designed by é•œ & Claude & Gemini
        </div>
    </div>

    <!-- èœå•åˆ‡æ¢æŒ‰é’® -->
    <div class="menu-toggle" onclick="toggleMenu()" title="æ‰“å¼€/å…³é—­ä¸»é¢˜ç¼–è¾‘å™¨">
        ğŸ¨
    </div>

    <!-- æ‚¬æµ®æ§åˆ¶é¢æ¿ -->
    <div class="controls" id="controls-panel" data-html2canvas-ignore="true">
        <div class="controls-header">ä¸»é¢˜ç¼–è¾‘å™¨</div>
        
        <div class="theme-section">
            <div class="section-title">ä¸»é¢˜é…è‰²</div>
            <div class="theme-grid">
                <button class="btn theme-btn" data-theme="theme-å®‡å®™æ˜Ÿ" onclick="setTheme('theme-å®‡å®™æ˜Ÿ')">å®‡å®™æ˜Ÿ</button>
                <button class="btn theme-btn" data-theme="theme-æ‹çˆ±é€šå‘Š" onclick="setTheme('theme-æ‹çˆ±é€šå‘Š')">æ‹çˆ±é€šå‘Š</button>
                <button class="btn theme-btn" data-theme="theme-æ—¥å½±ä¸‹" onclick="setTheme('theme-æ—¥å½±ä¸‹')">æ—¥å½±ä¸‹</button>
                <button class="btn theme-btn" data-theme="theme-çº¢ä¸é»‘" onclick="setTheme('theme-çº¢ä¸é»‘')">çº¢ä¸é»‘</button>
                <button class="btn theme-btn" data-theme="theme-è†æ£˜æµ·" onclick="setTheme('theme-è†æ£˜æµ·')">è†æ£˜æµ·</button>
                <button class="btn theme-btn" data-theme="theme-è¿·é›¾è“" onclick="setTheme('theme-è¿·é›¾è“')">è¿·é›¾è“</button>
            </div>
        </div>

        <div class="theme-section">
            <div class="section-title">è‡ªå®šä¹‰</div>
            <div class="theme-grid">
                <button class="btn" onclick="toggleCustomEditor()">æ‰“å¼€è°ƒè‰²æ¿</button>
            </div>
        </div>

        <div class="theme-section">
            <div class="section-title">æœˆä»½ç®¡ç†</div>
            <div id="month-restorer" style="padding: 5px; min-height: 20px;">
                <div style="font-size: 12px; color: #999; font-style: italic;">ç‚¹å‡»å·²åˆ é™¤çš„æœˆä»½å¯æ¢å¤</div>
                <!-- åŠ¨æ€ç”Ÿæˆçš„æ¢å¤æŒ‰é’®å°†æ”¾åœ¨è¿™é‡Œ -->
            </div>
        </div>

        <div id="custom-editor" style="display: none; margin-top: 10px; padding: 12px; background: #f9f9f9; border-radius: 8px;">
            <div style="font-size: 13px; font-weight: 600; margin-bottom: 10px; color: #333;">è‡ªå®šä¹‰é…è‰²</div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-size: 12px; width: 70px;">èƒŒæ™¯è‰²:</label>
                    <input type="color" id="custom-bg" value="#f4f1ea" style="width: 60px; height: 30px; border: none; border-radius: 4px; cursor: pointer;">
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-size: 12px; width: 70px;">æ–‡å­—è‰²:</label>
                    <input type="color" id="custom-text" value="#2c2c2c" style="width: 60px; height: 30px; border: none; border-radius: 4px; cursor: pointer;">
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-size: 12px; width: 70px;">å¼ºè°ƒè‰²:</label>
                    <input type="color" id="custom-accent" value="#8b4513" style="width: 60px; height: 30px; border: none; border-radius: 4px; cursor: pointer;">
                </div>
                <button class="btn" onclick="applyCustomTheme()" style="margin-top: 8px; font-size: 12px;">åº”ç”¨é…è‰²</button>
            </div>
        </div>

        <button class="btn btn-primary" onclick="generateImage()">ç”Ÿæˆé•¿å›¾</button>
        <div style="font-size: 11px; color: #999; margin-top: 5px; text-align: center;">
            å¿«æ·é”®: Ctrl+S<br>
            <a href="#" onclick="clearAllData(); return false;" style="color: #999; text-decoration: underline; font-size: 10px;">æ¸…é™¤æ‰€æœ‰è¾“å…¥</a>
        </div>
    </div>

    <!-- çº¸å¼ åŒºåŸŸ (å°†è¢«æˆªå›¾) -->
    <div id="paper-container">
        <div class="content-wrapper">
            <!-- å¤´éƒ¨ä¿¡æ¯ -->
            <div class="summary-header" style="text-align: center; margin-bottom: 40px; border-bottom: 2px dashed var(--accent-color); padding-bottom: 20px;">
                <div class="footer-title" contenteditable="true" spellcheck="false" title="ç‚¹å‡»å¯ä¿®æ”¹æ ‡é¢˜">é…’é¦†2025å¹´åº¦æ€»ç»“</div>
                <div class="maker-info">
                    <div>åˆ¶è¡¨äººï¼šé•œ</div>
                    <div style="display:flex; align-items:baseline;">
                        å¡«è¡¨äººï¼š<input type="text" class="input-line" style="width:120px; text-align:center;">
                    </div>
                </div>
            </div>

            <!-- åŸºç¡€æ•°æ® -->
            <div class="section">
                <div class="question-row">
                    ç©é…’é¦†å·²ç» <input type="text" class="input-line" placeholder="è¾“å…¥å¤©æ•°" style="text-align:center; width:60px; flex:none;"> å¤©äº†
                </div>
                <div class="question-row">
                    ä»Šå¹´è·Ÿ<span id="toggle-amount" class="editable-text" onclick="toggleAmount(this)" style="margin:0 5px; font-weight:bold; color:var(--accent-color);">å¥½å¤š</span>äººèŠè¿‡ï¼ŒTaä»¬æ˜¯ï¼š
                </div>
                <textarea class="textarea-box" placeholder="ä½ è¿˜è®°å¾—ä»–ä»¬çš„åå­—å˜›ï¼Ÿ"></textarea>
            </div>

            <!-- è‡ªå®šä¹‰å¡«ç©º -->
            <div class="section">
                <div class="question-row">
                    <span class="label">ç©å¾—æœ€<span class="editable-text" contenteditable="true" spellcheck="false">å¼€å¿ƒ</span>çš„æ˜¯ï¼š</span>
                    <input type="text" class="input-line" placeholder="è°ï¼Ÿ">
                </div>
                <div class="question-row">
                    <span class="label">ç©å¾—æœ€<span class="editable-text" contenteditable="true" spellcheck="false">è™å¿ƒ</span>çš„æ˜¯ï¼š</span>
                    <input type="text" class="input-line" placeholder="è°ï¼Ÿ">
                </div>
                <div class="question-row">
                    <span class="label">ç©å¾—æœ€<span class="editable-text" contenteditable="true" spellcheck="false">æ— è¯­</span>çš„æ˜¯ï¼š</span>
                    <input type="text" class="input-line" placeholder="è°ï¼Ÿ">
                </div>
                <div class="question-row">
                    <span class="label">ç©å¾—æœ€<span class="editable-text" contenteditable="true" spellcheck="false">åˆºæ¿€</span>çš„æ˜¯ï¼š</span>
                    <input type="text" class="input-line" placeholder="åˆæ˜¯è°ï¼Ÿ">
                </div>
            </div>

            <div class="divider"> é‚£ä¹ˆæ¥å›é¡¾ä¸€ä¸‹å§ï¼ </div>

            <!-- 12ä¸ªæœˆä»½å¾ªç¯ç”Ÿæˆ -->
            <div id="months-container">
                <!-- JSä¼šè‡ªåŠ¨å¡«å……è¿™é‡Œï¼Œé¿å…ä»£ç å¤ªé•¿ -->
            </div>

            <div class="divider"> æ€»ç»“æ—¶åˆ» </div>

            <!-- ç»“å°¾ -->
            <div class="section">
                <div class="question-row">
                    <span class="label">ç©äº†è¿™ä¹ˆä¹…ï¼Œæˆ‘æœ€å–œæ¬¢çš„LLMæ¨¡å‹æ˜¯ï¼Ÿ</span>
                </div>
                <input type="text" class="input-line">
                
                <div class="question-row" style="margin-top: 20px;">
                    <span class="label">èŠäº†è¿™ä¹ˆå¤šï¼Œé…’é¦†å¯¹æˆ‘äº§ç”Ÿæœ€å¤§çš„å½±å“æ˜¯ï¼Ÿ</span>
                </div>
                <textarea class="textarea-box" style="min-height: 100px;"></textarea>

                <div class="question-row" style="margin-top: 20px;">
                    <span class="label">é‚£ä¹ˆï¼Œæ˜å¹´è¿˜ç©å—ï¼Ÿ</span>
                    <textarea class="textarea-box" placeholder="æˆ‘ä»¬è¯´å¥½è¦ç©ä¸€è¾ˆå­çš„é…’é¦†çš„ï¼ï¼ˆå¹¶æ²¡æœ‰"></textarea>
                </div>

                <div class="question-row" style="margin-top: 20px;">
                    <span class="label">ä¹Ÿè®¸ï¼Œè¿˜éœ€è¦å˜€å˜€å’•å’•ä»€ä¹ˆï¼Ÿ</span>
                </div>
                <textarea class="textarea-box" placeholder="èŠç‚¹ä»€ä¹ˆå§~"></textarea>
            </div>

            <!-- ç”Ÿæˆå›¾åº•éƒ¨ç½‘å€ -->
            <div class="generated-url">
                https://jingshiro.github.io/year-in-st
            </div>
        </div>
    </div>

    <script>
        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2500);
        }

        // åˆ‡æ¢ "å¥½å¤š/å¥½å°‘"
        function toggleAmount(element) {
            if (element.textContent === 'å¥½å¤š') {
                element.textContent = 'å¥½å°‘';
            } else {
                element.textContent = 'å¥½å¤š';
            }
        }

        // è‡ªåŠ¨ç”Ÿæˆ12ä¸ªæœˆä»½çš„HTML
        const monthsContainer = document.getElementById('months-container');
        const monthRestorer = document.getElementById('month-restorer');
        const monthNames = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];

        // åˆå§‹åŒ–æœˆä»½
        monthNames.forEach((month, index) => {
            const monthId = `month-${index}`;
            const monthHtml = `
                <div class="month-block" id="${monthId}">
                    <div class="delete-btn" onclick="deleteMonth('${monthId}', '${month}')" title="åˆ é™¤è¿™ä¸ªæœˆä»½">Ã—</div>
                    
                    <div class="restore-img-btn" id="restore-img-${index}" onclick="restoreImage(${index})" style="display:none;">ğŸ“· æ¢å¤ç…§ç‰‡</div>

                    <div class="polaroid" id="polaroid-${index}" onclick="document.getElementById('file-${index}').click()" title="ç‚¹å‡»ä¸Šä¼ å¤´åƒ">
                        <div class="delete-img-btn" onclick="deleteImage(event, ${index})" title="ç§»é™¤ç…§ç‰‡åŒºåŸŸ">Ã—</div>
                        <img id="img-${index}" class="polaroid-img" style="display:none;">
                        <div class="polaroid-placeholder" id="ph-${index}">
                            ğŸ“·
                            <span>Avatar</span>
                        </div>
                        <input type="file" id="file-${index}" accept="image/*" onchange="handleImageUpload(this, ${index})" style="display:none">
                    </div>

                    <div class="month-title">${month}</div>
                    <div class="question-row">
                        <span class="label">ä»£è¡¨Charæ˜¯ï¼š</span>
                        <input type="text" class="input-line" placeholder="Taçš„åå­—...">
                    </div>
                    <div class="question-row">
                        <span class="label">æœ€æˆ³çš„ç‰‡æ®µæ˜¯ï¼š</span>
                    </div>
                    <textarea class="textarea-box" placeholder="å¤åˆ¶ç²˜è´´ä¸€æ®µèŠå¤©è®°å½•..."></textarea>
                    <div class="question-row" style="margin-top:10px;">
                        <span class="label">Userçš„ç¢ç¢å¿µtimeï¼š</span>
                    </div>
                    <textarea class="textarea-box textarea-short" placeholder="å½“æ—¶çš„å¿ƒæƒ…/åæ§½/å°ä½œæ–‡..." style="height: 60px;"></textarea>
                </div>
            `;
            monthsContainer.insertAdjacentHTML('beforeend', monthHtml);
        });

        // åˆ é™¤æœˆä»½
        function deleteMonth(id, name) {
            const el = document.getElementById(id);
            if (el) {
                el.style.display = 'none';
                addRestoreBtn(id, name);
                showToast(`å·²éšè— ${name}`);
            }
        }

        // æ·»åŠ æ¢å¤æŒ‰é’®
        function addRestoreBtn(id, name) {
            const btn = document.createElement('span');
            btn.className = 'restore-tag';
            btn.textContent = `+ ${name}`;
            btn.onclick = () => restoreMonth(id, btn);
            monthRestorer.appendChild(btn);
        }

        // æ¢å¤æœˆä»½
        function restoreMonth(id, btnElement) {
            const el = document.getElementById(id);
            if (el) {
                el.style.display = 'block';
                el.style.animation = 'slideIn 0.5s ease-out';
                btnElement.remove();
                showToast(`å·²æ¢å¤æœˆä»½`);
            }
        }

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload(input, index) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById(`img-${index}`);
                    const ph = document.getElementById(`ph-${index}`);
                    img.src = e.target.result;
                    img.style.display = 'block';
                    ph.style.display = 'none';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // åˆ é™¤å›¾ç‰‡åŒºåŸŸ
        function deleteImage(e, index) {
            e.stopPropagation(); // é˜»æ­¢å†’æ³¡è§¦å‘ä¸Šä¼ 
            const polaroid = document.getElementById(`polaroid-${index}`);
            const restoreBtn = document.getElementById(`restore-img-${index}`);
            
            polaroid.style.display = 'none';
            restoreBtn.style.display = 'block';
            
            showToast('å·²ç§»é™¤ç…§ç‰‡åŒºåŸŸ');
        }

        // æ¢å¤å›¾ç‰‡åŒºåŸŸ
        function restoreImage(index) {
            const polaroid = document.getElementById(`polaroid-${index}`);
            const restoreBtn = document.getElementById(`restore-img-${index}`);
            
            polaroid.style.display = 'flex';
            restoreBtn.style.display = 'none';
            
            showToast('å·²æ¢å¤ç…§ç‰‡åŒºåŸŸ');
        }

        // ä¸»é¢˜åç§°æ˜ å°„
        const themeNames = {
            'theme-å®‡å®™æ˜Ÿ': 'å®‡å®™æ˜Ÿ',
            'theme-æ‹çˆ±é€šå‘Š': 'æ‹çˆ±é€šå‘Š',
            'theme-æ—¥å½±ä¸‹': 'æ—¥å½±ä¸‹',
            'theme-çº¢ä¸é»‘': 'çº¢ä¸é»‘',
            'theme-è†æ£˜æµ·': 'è†æ£˜æµ·',
            'theme-è¿·é›¾è“': 'è¿·é›¾è“'
        };

        // èœå•åˆ‡æ¢é€»è¾‘
        function toggleMenu() {
            const controls = document.getElementById('controls-panel');
            const toggle = document.querySelector('.menu-toggle');
            controls.classList.toggle('active');
            toggle.classList.toggle('active');
        }

        // åˆ‡æ¢ä¸»é¢˜
        function setTheme(themeName) {
            // æ¸…é™¤è‡ªå®šä¹‰æ ·å¼
            const root = document.documentElement;
            root.style.removeProperty('--bg-color');
            root.style.removeProperty('--text-color');
            root.style.removeProperty('--accent-color');
            root.style.removeProperty('--border-color');
            root.style.removeProperty('--highlight-bg');
            root.style.removeProperty('--shadow-color');
            root.style.removeProperty('--paper-texture');

            document.body.className = themeName === 'default' ? '' : themeName;
            
            // æ›´æ–°æŒ‰é’®æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.querySelector(`.theme-btn[data-theme="${themeName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            // å…³é—­è‡ªå®šä¹‰ç¼–è¾‘å™¨ï¼ˆä¿æŒä¾§è¾¹æ æ‰“å¼€çŠ¶æ€ï¼‰
            document.getElementById('custom-editor').style.display = 'none';
            
            // ä¿å­˜ä¸»é¢˜é€‰æ‹©
            if (themeName !== 'default') {
                localStorage.setItem('selectedTheme', themeName);
            }
            
            // æ˜¾ç¤ºæç¤º
            if (themeNames[themeName]) {
                showToast(`å·²åˆ‡æ¢åˆ° ${themeNames[themeName]} ä¸»é¢˜`);
            }
        }

        // åˆ‡æ¢è‡ªå®šä¹‰ç¼–è¾‘å™¨
        function toggleCustomEditor() {
            const editor = document.getElementById('custom-editor');
            const isVisible = editor.style.display !== 'none';
            editor.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                showToast('è¿›å…¥è‡ªå®šä¹‰æ¨¡å¼');
            }
        }

        // åº”ç”¨è‡ªå®šä¹‰ä¸»é¢˜
        function applyCustomTheme() {
            const bg = document.getElementById('custom-bg').value;
            const text = document.getElementById('custom-text').value;
            const accent = document.getElementById('custom-accent').value;

            // æ¸…é™¤é¢„è®¾ä¸»é¢˜
            document.body.className = '';

            // ç›´æ¥ä¿®æ”¹ CSS å˜é‡
            const root = document.documentElement;
            root.style.setProperty('--bg-color', bg);
            root.style.setProperty('--text-color', text);
            root.style.setProperty('--accent-color', accent);
            
            // åŠ¨æ€è®¡ç®—è¾¹æ¡†è‰²å’Œé«˜å…‰è‰²
            const accentRGB = hexToRgb(accent);
            root.style.setProperty('--border-color', `rgba(${accentRGB.r}, ${accentRGB.g}, ${accentRGB.b}, 0.3)`);
            root.style.setProperty('--highlight-bg', `rgba(${accentRGB.r}, ${accentRGB.g}, ${accentRGB.b}, 0.08)`);
            root.style.setProperty('--shadow-color', `rgba(${accentRGB.r}, ${accentRGB.g}, ${accentRGB.b}, 0.3)`);
            root.style.setProperty('--paper-texture', 'none');

            showToast('è‡ªå®šä¹‰ä¸»é¢˜å·²åº”ç”¨');
        }

        // åå…­è¿›åˆ¶é¢œè‰²è½¬RGB
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 0, g: 0, b: 0 };
        }

        // ç”Ÿæˆå›¾ç‰‡
        function generateImage() {
            const paper = document.getElementById('paper-container');
            const btn = document.querySelector('.btn-primary');
            const originalText = btn.innerText;
            
            btn.innerText = 'ç”Ÿæˆä¸­...';
            btn.disabled = true;
            btn.classList.add('loading');

            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            window.scrollTo(0, 0);
            showToast('æ­£åœ¨ç”Ÿæˆé•¿å›¾ï¼Œè¯·ç¨å€™...');

            // å»¶æ—¶æ‰§è¡Œï¼Œç¡®ä¿UIåˆ·æ–°
            setTimeout(() => {
                // 1. å‡†å¤‡ç”Ÿæˆ
                document.body.classList.add('generating-image');

                // 2. æ›¿æ¢è¾“å…¥æ¡†ä¸ºæ–‡æœ¬
                const cleanupInputs = replaceInputsWithText();

                // 3. è·å–èƒŒæ™¯è‰²
                const computedStyle = getComputedStyle(document.body);
                let bgColor = computedStyle.getPropertyValue('--bg-color').trim();
                if (!bgColor || bgColor === 'transparent' || bgColor.includes('rgba(0, 0, 0, 0)')) {
                    bgColor = '#f4f1ea'; 
                }

                // 4. æ‰§è¡Œæˆªå›¾
                html2canvas(paper, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: bgColor,
                    logging: false,
                    removeContainer: true,
                    imageTimeout: 15000,
                    ignoreElements: (element) => {
                        return element.classList && (
                            element.classList.contains('controls') || 
                            element.classList.contains('menu-toggle') ||
                            element.classList.contains('delete-btn') || 
                            element.classList.contains('delete-img-btn') ||
                            element.classList.contains('restore-img-btn') ||
                            element.classList.contains('copyright-watermark') ||
                            element.id === 'toast'
                        );
                    }
                }).then(canvas => {
                    try {
                        const timestamp = new Date().toISOString().slice(0,10).replace(/-/g, '');
                        canvas.toBlob(function(blob) {
                            if (!blob) {
                                throw new Error('å›¾ç‰‡ç”Ÿæˆä¸ºç©º');
                            }
                            const link = document.createElement('a');
                            link.download = `SillyTavernå¹´åº¦æ€»ç»“_${timestamp}.png`;
                            link.href = URL.createObjectURL(blob);
                            link.click();
                            
                            setTimeout(() => {
                                URL.revokeObjectURL(link.href);
                            }, 100);
                            
                            showToast('å›¾ç‰‡å·²ç”Ÿæˆï¼Œè¯·æŸ¥çœ‹ä¸‹è½½æ–‡ä»¶å¤¹');
                        }, 'image/png');
                    } catch (e) {
                        console.error('å¯¼å‡ºå¤±è´¥:', e);
                        showToast('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                }).catch(err => {
                    console.error('ç”Ÿæˆå¤±è´¥:', err);
                    showToast('ç”Ÿæˆå¤±è´¥ï¼Œå¯èƒ½æ˜¯å›¾ç‰‡å¤ªå¤§');
                }).finally(() => {
                    cleanupInputs();
                    document.body.classList.remove('generating-image');
                    
                    btn.innerText = originalText;
                    btn.disabled = false;
                    btn.classList.remove('loading');
                });

            }, 500);
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ›¿æ¢è¾“å…¥æ¡†ä¸ºæ–‡æœ¬èŠ‚ç‚¹
        function replaceInputsWithText() {
            const inputs = document.querySelectorAll('input, textarea');
            const replacements = [];

            inputs.forEach(input => {
                // å¿½ç•¥éšè—çš„ input (å¦‚ file input)
                if (input.style.display === 'none' || input.type === 'file' || input.type === 'hidden') return;

                const style = getComputedStyle(input);
                const rect = input.getBoundingClientRect();
                const text = input.value;

                // åˆ›å»ºæ›¿èº«å…ƒç´ 
                const div = document.createElement('div');
                div.textContent = text;
                div.className = 'print-text-replacement'; // åº”ç”¨åŸºç¡€æ‰“å°æ ·å¼

                // å¤åˆ¶å…³é”®æ ·å¼
                div.style.width = rect.width + 'px'; // å¼ºåˆ¶åŒå®½
                div.style.minHeight = rect.height + 'px'; // å¼ºåˆ¶åŒé«˜
                
                // å­—ä½“æ ·å¼
                div.style.fontFamily = style.fontFamily;
                div.style.fontSize = style.fontSize;
                div.style.fontWeight = style.fontWeight;
                div.style.color = style.color;
                div.style.textAlign = style.textAlign;
                
                // å¸ƒå±€æ ·å¼
                div.style.padding = style.padding;
                div.style.margin = style.margin;
                div.style.display = style.display === 'inline-block' ? 'inline-block' : 'block';
                
                // ç‰¹æ®Šå¤„ç† input çš„å‚ç›´å±…ä¸­
                if (input.tagName === 'INPUT') {
                    div.style.display = 'flex';
                    div.style.alignItems = 'center';
                    // å¯¹é½æ–¹å¼è½¬æ¢
                    if (style.textAlign === 'center') div.style.justifyContent = 'center';
                    else if (style.textAlign === 'right') div.style.justifyContent = 'flex-end';
                    else div.style.justifyContent = 'flex-start';
                }

                // æ’å…¥æ›¿èº«ï¼Œéšè—çœŸèº«
                input.parentNode.insertBefore(div, input);
                input.style.display = 'none';

                replacements.push({ input, div });
            });

            // åŒæ—¶ä¹Ÿå¤„ç† contenteditable å…ƒç´ ï¼Œç§»é™¤ç¼–è¾‘å±æ€§ï¼Œé˜²æ­¢å…‰æ ‡å‡ºç°
            const editables = document.querySelectorAll('[contenteditable]');
            editables.forEach(el => {
                el.setAttribute('data-was-editable', 'true');
                el.removeAttribute('contenteditable');
            });

            // è¿”å›æ¸…ç†å‡½æ•°
            return () => {
                replacements.forEach(({ input, div }) => {
                    div.remove();
                    input.style.display = ''; // æ¢å¤é»˜è®¤ display
                });
                
                editables.forEach(el => {
                    if (el.getAttribute('data-was-editable')) {
                        el.setAttribute('contenteditable', 'true');
                        el.removeAttribute('data-was-editable');
                    }
                });
            };
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ¢å¤ä¸Šæ¬¡é€‰æ‹©çš„ä¸»é¢˜
            const savedTheme = localStorage.getItem('selectedTheme');
            if (savedTheme) {
                setTheme(savedTheme);
            }
            
            // æ¢å¤ "å¥½å¤š/å¥½å°‘" çŠ¶æ€
            const savedAmount = localStorage.getItem('toggle_amount');
            if (savedAmount) {
                document.getElementById('toggle-amount').textContent = savedAmount;
            }

            // ç›‘å¬ "å¥½å¤š/å¥½å°‘" å˜åŒ–
            document.getElementById('toggle-amount').addEventListener('click', function() {
                // å»¶æ—¶ä¸€ç‚¹ç­‰å¾…æ–‡å­—å˜åŒ–
                setTimeout(() => {
                    localStorage.setItem('toggle_amount', this.textContent);
                }, 0);
            });

            // æ·»åŠ è¾“å…¥æ¡†çš„ä¿å­˜åŠŸèƒ½ï¼ˆä½¿ç”¨localStorageï¼‰
            const inputs = document.querySelectorAll('.input-line, .textarea-box');
            
            inputs.forEach((input, index) => {
                const savedValue = localStorage.getItem(`input_${index}`);
                if (savedValue) {
                    input.value = savedValue;
                }
                input.addEventListener('input', function() {
                    localStorage.setItem(`input_${index}`, this.value);
                });
            });

            // å¯ç¼–è¾‘æ–‡æœ¬çš„ä¿å­˜åŠŸèƒ½
            const editables = document.querySelectorAll('[contenteditable]');
            editables.forEach((el, index) => {
                // ä¸ºæ¯ä¸ªcontenteditableå…ƒç´ ç”Ÿæˆå”¯ä¸€IDï¼ˆå¦‚æœå·²å­˜åœ¨IDåˆ™ä½¿ç”¨ï¼Œå¦åˆ™ç”Ÿæˆï¼‰
                // è¿™é‡Œæˆ‘ä»¬ç®€å•åœ°ç”¨ç±»å+ç´¢å¼•æˆ–ç‰¹å®šIDæ¥åŒºåˆ†
                let storageKey;
                if (el.classList.contains('footer-title')) {
                    storageKey = 'custom_footer_title';
                } else {
                    storageKey = `editable_${index}`;
                }

                const savedText = localStorage.getItem(storageKey);
                if (savedText) {
                    el.textContent = savedText;
                }
                
                el.addEventListener('input', function() {
                    localStorage.setItem(storageKey, this.textContent);
                });
            });

            // æ˜¾ç¤ºæ¬¢è¿æç¤º
            setTimeout(() => {
                showToast('æ¬¢è¿ä½¿ç”¨å¹´åº¦æ€»ç»“ç”Ÿæˆå™¨');
            }, 500);

            // ä¸ºè¾“å…¥æ¡†æ·»åŠ åŠ¨ç”»æ•ˆæœ
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    this.style.transform = 'scale(1.02)';
                });
                input.addEventListener('blur', function() {
                    this.style.transform = 'scale(1)';
                });
            });
        });

        // æ¸…é™¤æ‰€æœ‰è¾“å…¥æ•°æ®
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è¾“å…¥å†…å®¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                // æ¸…é™¤localStorage
                localStorage.clear();
                
                // æ¸…é™¤æ‰€æœ‰è¾“å…¥æ¡†
                const inputs = document.querySelectorAll('.input-line, .textarea-box, [contenteditable]');
                inputs.forEach(input => {
                    if (input.tagName === 'INPUT' || input.tagName === 'TEXTAREA') {
                        input.value = '';
                    } else {
                        // é‡ç½®å¯ç¼–è¾‘æ–‡æœ¬ä¸ºé»˜è®¤å€¼
                        if (input.classList.contains('footer-title')) {
                            input.textContent = 'é…’é¦†å¦¹å¹´åº¦æ€»ç»“';
                        } else {
                            // å…¶ä»–å¯ç¼–è¾‘spané‡ç½®ä¸ºç©ºæˆ–è€…ä¿ç•™åŸæ ·ï¼Ÿè¿™é‡Œç®€å•é‡ç½®ä¸ºç©ºæˆ–é»˜è®¤æç¤ºå¯èƒ½æ¯”è¾ƒéš¾åˆ¤æ–­ï¼Œæš‚ä¸å¤„ç†å†…å®¹æ¸…ç©ºï¼Œåªæ¸…ç©ºå­˜å‚¨
                            // æˆ–è€…æ ¹æ®éœ€æ±‚æ¸…ç©º
                        }
                    }
                });

                // é‡ç½® "å¥½å¤š/å¥½å°‘"
                document.getElementById('toggle-amount').textContent = 'å¥½å¤š';

                // é‡ç½®å›¾ç‰‡
                document.querySelectorAll('.polaroid-img').forEach(img => {
                    img.src = '';
                    img.style.display = 'none';
                });
                document.querySelectorAll('.polaroid-placeholder').forEach(ph => {
                    ph.style.display = 'block';
                });
                
                // é‡ç½®å·²åˆ é™¤çš„æœˆä»½
                monthRestorer.innerHTML = '';
                document.querySelectorAll('.month-block').forEach(el => {
                    el.style.display = 'block';
                });

                showToast('å·²æ¸…é™¤æ‰€æœ‰è¾“å…¥å†…å®¹');
            }
        }

        // æ·»åŠ é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + S ä¿å­˜å›¾ç‰‡
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                generateImage();
            }
        });
    </script>
</body>
</html>